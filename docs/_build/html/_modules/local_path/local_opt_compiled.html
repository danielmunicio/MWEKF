<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>local_path.local_opt_compiled &mdash; Pipeline 131 Mk. S documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  
        <script src="../../_static/documentation_options.js?v=e97658a3"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Pipeline 131
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../graphslam_global.html">Graph-Based SLAM Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mpc.html">Model Predictive Control</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Pipeline 131</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>local_path.local_opt_compiled</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for local_path.local_opt_compiled</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">casadi</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
<span class="kn">from</span> <span class="nn">.dynamics</span> <span class="kn">import</span> <span class="n">discrete_custom_integrator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># hsl checking fuckery</span>
<span class="c1"># only works on mac/linux. if you havee windows, I&#39;m willing to bet you have bigger problems.</span>
<span class="n">hsl_avail</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">paths</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="n">linuxpath</span> <span class="k">if</span> <span class="p">(</span><span class="n">linuxpath</span><span class="o">:=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LD_LIBRARY_PATH&#39;</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                  <span class="p">(</span><span class="n">macospath</span> <span class="k">if</span> <span class="p">(</span><span class="n">macospath</span><span class="o">:=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DYLD_LIBRARY_PATH&#39;</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)])</span>
<span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">paths</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="s1">&#39;libhsl&#39;</span> <span class="ow">in</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)]):</span>
        <span class="n">hsl_avail</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">break</span>

<span class="k">assert</span> <span class="n">hsl_avail</span><span class="p">,</span> <span class="s2">&quot;You must have HSL linear solvers installed on your system, but they were not found (or you have windows). If you&#39;re on windows, comment out this line.&quot;</span>

<span class="c1">## MPC class variable that&#39;ll keep info abt the car + help us solve optimzation problems!</span>
<div class="viewcode-block" id="CompiledLocalOpt">
<a class="viewcode-back" href="../../local_path.html#local_path.local_opt_compiled.CompiledLocalOpt">[docs]</a>
<span class="k">class</span> <span class="nc">CompiledLocalOpt</span><span class="p">:</span>
    <span class="n">DEFAULT_SOPTS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ipopt&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;ipopt.linear_solver&#39;</span><span class="p">:</span> <span class="s1">&#39;ma57&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expand&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="c1"># &#39;ipopt.print_level&#39;: 0,</span>
            <span class="c1"># &#39;ipopt.sb&#39;: &#39;yes&#39;,</span>
            <span class="c1"># &#39;ipopt.ma57_automatic_scaling&#39;: &#39;no&#39;,</span>
            <span class="c1"># &#39;print_time&#39;: 0,</span>
        <span class="p">},</span>
        <span class="s1">&#39;worhp&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># https://casadi.sourceforge.net/v1.9.0/api/html/dc/ddf/classCasADi_1_1WorhpSolver.html</span>
            <span class="s1">&#39;expand&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;worhp.NLPprint&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;snopt&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;expand&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="c1"># &#39;start&#39;: &quot;warm&quot;</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">nlp_solver</span><span class="o">=</span><span class="s1">&#39;ipopt&#39;</span><span class="p">,</span> <span class="n">solver_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">car_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;l_r&#39;</span><span class="p">:</span> <span class="mf">1.4987</span><span class="p">,</span> <span class="s1">&#39;l_f&#39;</span><span class="p">:</span><span class="mf">1.5213</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">},</span> <span class="n">bbox</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="o">**</span><span class="n">constraints</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;initializes a CompiledLocalOpt object.</span>

<span class="sd">        Args:</span>
<span class="sd">            N (int): number of points to expect in the path.</span>
<span class="sd">            nlp_solver (str, optional): which NLP solver plugin to use. can be &#39;ipopt&#39;, &#39;worhp&#39;, &#39;snopt&#39;, or whatever you have installed. Defaults to &#39;ipopt&#39;.</span>
<span class="sd">            solver_opts (dict, optional): options to pass to NLP solver. if None, use default options. Defaults to None.</span>
<span class="sd">            car_params (dict, optional): parameters for dynamics model (currently bicycle model). Defaults to {&#39;l_r&#39;: 1.4987, &#39;l_f&#39;:1.5213, &#39;m&#39;: 1.}.</span>
<span class="sd">            bbox (dict, optional): length and width of car (assumes car is roughly rectangular). Defaults to {&#39;l&#39;: 2, &#39;w&#39;: 1}.</span>
<span class="sd">            DF_MAX (float, optional): maximum steering angle (radians). Defaults to 0.5.</span>
<span class="sd">            ACC_MIN (float, optional): maximum braking acceleration (m/s^2, should be &lt;0). Defaults to -3.0.</span>
<span class="sd">            ACC_MAX_FN (float or casadi.Function, optional): function of velocity (m/s) which gives maximum forward acceleration (m/s^2) at that velocity, or constant max. Should be torque at that velocity divided by mass of car (ie, no aero consideration). Defaults to 2.0.</span>
<span class="sd">            V_MIN (float, optional): minimum velocity. Defaults to 0.0.</span>
<span class="sd">            V_MAX (float, optional): maximum velocity. Defaults to 25.0.</span>
<span class="sd">            FRIC_MAX (float or casadi.Function, optional): function of velocity (m/s) which gives maximum frictional acceleration (m/s^2) at that velocity, or constant max. Defaults to 12.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">car_params</span> <span class="o">=</span> <span class="n">car_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlp_solver</span> <span class="o">=</span> <span class="n">nlp_solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sopts</span> <span class="o">=</span> <span class="n">solver_opts</span> <span class="k">if</span> <span class="n">solver_opts</span> <span class="k">else</span> <span class="n">CompiledLocalOpt</span><span class="o">.</span><span class="n">DEFAULT_SOPTS</span><span class="p">[</span><span class="n">nlp_solver</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_solver</span> <span class="o">=</span> <span class="s1">&#39;MA97&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlp_solver</span> <span class="o">==</span> <span class="s1">&#39;worhp&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sopts</span><span class="p">[</span><span class="s1">&#39;ipopt.linear_solver&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ipopt.linear_solver&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sopts</span> <span class="k">else</span> <span class="s1">&#39;MUMPS&#39;</span>
        
        <span class="c1">####* constraints ####</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DF_MAX</span>  <span class="o">=</span>  <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACC_MIN</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ACC_MAX_FN</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DF_DOT_MAX</span> <span class="o">=</span>  <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_MIN</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_MAX</span> <span class="o">=</span> <span class="mf">25.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FRIC_MAX</span> <span class="o">=</span> <span class="mf">12.0</span>

        <span class="c1"># update with user provided constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>

        <span class="c1"># if not Function objects already, make the acceleration limiting functions </span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">SX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FRIC_MAX</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FRIC_MAX</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;FRIC_MAX&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">FRIC_MAX</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ACC_MAX_FN</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ACC_MAX_FN</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;ACC_MAX_FN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ACC_MAX_FN</span><span class="p">])</span>

        <span class="c1">####* utility functions ####</span>
        <span class="c1"># easy way to account for angle wrapping</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="c1"># self.fix_angle = Function(&#39;fix_angle&#39;, [x], [horzcat(x[0, :], x[1, :], sin(2*x[2, :]), x[3, :])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_angle</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;fix_angle&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">horzcat</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:])])</span>
        <span class="c1"># generate 2x2 rotation matrices</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;psi&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rot</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;rot&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">psi</span><span class="p">],</span> <span class="p">[</span><span class="n">reshape</span><span class="p">(</span><span class="n">horzcat</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>

        <span class="c1">###########################################*</span>
        <span class="c1">####* Symbolic Variable Initialization ####*</span>
        <span class="c1">###########################################*</span>

        <span class="c1">#* Track parameters</span>
        <span class="n">currAndCones</span> <span class="o">=</span> <span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;bound_pairs&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_state</span> <span class="o">=</span> <span class="n">currAndCones</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bound_pairs</span> <span class="o">=</span> <span class="n">currAndCones</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>

        <span class="c1">#* opt variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sl_dyn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>

        <span class="c1">#* this represents the full state at each discretization point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">horzcat</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bound_pairs</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_pairs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="c1"># LERP between pairs of points on track bounds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">v</span>
        <span class="p">)</span>
        
        <span class="c1">#* this is the same thing but shifted by one index. Allows us to take diffs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_i</span> <span class="o">=</span> <span class="n">vertcat</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="p">)</span>
        <span class="c1">######################*</span>
        <span class="c1">####* Constraints ####*</span>
        <span class="c1">######################*</span>

        <span class="c1">#* get discrete dynamics function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span> <span class="o">=</span> <span class="n">discrete_custom_integrator</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">car_params</span><span class="p">)</span>
        <span class="c1">#* these will store our constraint expressions (g) and bounds (lbg, ubg)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ubg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#* table to keep track of indices of each constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gtable</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glen</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#* Dynamics constraints: # Math: F(z_i, u_i, \Delta t_i) == z_{i+1}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># print(self.z[i, :]);</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraint</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;dynamics</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_angle</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">T</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])),</span><span class="c1"># + self.sl_dyn[i, :]),</span>
                <span class="n">lbg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span>
                <span class="n">ubg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1">#* other constraints. all follow the same pattern.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraint</span><span class="p">(</span>
            <span class="s1">&#39;vel&#39;</span><span class="p">,</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">),</span>
            <span class="n">lbg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">V_MIN</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span>
            <span class="n">ubg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">V_MAX</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraint</span><span class="p">(</span>
            <span class="s1">&#39;acc_min&#39;</span><span class="p">,</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">lbg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ACC_MIN</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span>
            <span class="n">ubg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="n">inf</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraint</span><span class="p">(</span>
            <span class="s1">&#39;acc_max&#39;</span><span class="p">,</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ACC_MAX_FN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)),</span>
            <span class="n">lbg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="o">-</span><span class="n">inf</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span>
            <span class="n">ubg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraint</span><span class="p">(</span>
            <span class="s1">&#39;steering&#39;</span><span class="p">,</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="n">lbg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">DF_MAX</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span>
            <span class="n">ubg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">DF_MAX</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraint</span><span class="p">(</span>
            <span class="s1">&#39;dt&#39;</span><span class="p">,</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">),</span>
            <span class="n">lbg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span>
            <span class="n">ubg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraint</span><span class="p">(</span>
            <span class="s1">&#39;df_dot&#39;</span><span class="p">,</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">])),</span>
            <span class="n">lbg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">DF_DOT_MAX</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
            <span class="n">ubg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">DF_DOT_MAX</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraint</span><span class="p">(</span>
            <span class="s1">&#39;t&#39;</span><span class="p">,</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">),</span>
            <span class="n">lbg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="mf">0.4</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span>
            <span class="n">ubg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="mf">0.6</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Keeps initial heading and velocity unchangeable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraint</span><span class="p">(</span>
            <span class="s1">&#39;curr_velocity&#39;</span><span class="p">,</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">lbg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">ubg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># self._add_constraint(</span>
        <span class="c1">#     &#39;curr_heading&#39;,</span>
        <span class="c1">#     g = self.curr_state[2] - self.psi[0],</span>
        <span class="c1">#     lbg = DM(-pi/6),</span>
        <span class="c1">#     ubg = DM(pi/6)</span>
        <span class="c1"># )</span>
        <span class="c1"># Makes it so that the time to run is at minimum 2 (soft constraint, scalar included)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span> <span class="o">=</span> <span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s2">&quot;scalar&quot;</span><span class="p">)</span>
        <span class="c1"># self._add_constraint(</span>
        <span class="c1">#     &#39;min_time&#39;,</span>
        <span class="c1">#     g = sum1(self.dt) + self.scalar,</span>
        <span class="c1">#     lbg = DM(0.5),</span>
        <span class="c1">#     ubg = DM(float(&#39;inf&#39;))</span>
        <span class="c1"># )</span>
        <span class="c1"># centripetal acceleration: # Math: \frac{v^2}{r}=\frac{v^2}{\frac{v}{\dot{\theta}}}=\frac{v^2\dot{\theta}}{v}=v\dot{\theta}</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">car_params</span><span class="p">[</span><span class="s1">&#39;l_r&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">arctan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">car_params</span><span class="p">[</span><span class="s1">&#39;l_r&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">car_params</span><span class="p">[</span><span class="s1">&#39;l_f&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">car_params</span><span class="p">[</span><span class="s1">&#39;l_r&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">tan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraint</span><span class="p">(</span>
            <span class="s1">&#39;centripetal_acc&#39;</span><span class="p">,</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">ac</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">FRIC_MAX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">lbg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="o">-</span><span class="n">inf</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span>
            <span class="n">ubg</span> <span class="o">=</span> <span class="n">DM</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1">#* Cone Constraints: stop the car from hitting any cones</span>
        <span class="c1"># TODO: allow the cone locations to be different from the track side points</span>

        <span class="c1">#* construct a function which is close enough to a rectangle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">safe</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;safespace&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">:=</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="p">[(</span><span class="n">DM</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox</span><span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">]])</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="nd">@x</span><span class="o">**</span><span class="mi">6</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cones</span> <span class="o">=</span> <span class="n">vertcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bound_pairs</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_pairs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_pairs</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_pairs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1">#* number of cones to consider (ahead of and behind the current cone, on each side)</span>
        <span class="n">considered</span> <span class="o">=</span> <span class="n">horzcat</span><span class="p">(</span><span class="n">left</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">right</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="k">pass</span>
            <span class="c1"># self._add_constraint(</span>
            <span class="c1">#     f&#39;cones{i}&#39;,</span>
            <span class="c1">#     g=self.safe(self.rot(-self.psi[i])@((considered-self.z[i, :2].T) + vertcat(self.car_params[&#39;l_f&#39;]-self.car_params[&#39;l_r&#39;], 0))).T, </span>
            <span class="c1">#     lbg=DM([1.0]*(self.N-2)*2),</span>
            <span class="c1">#     ubg=DM([inf]*(self.N-2)*2)</span>
            <span class="c1"># )</span>


        <span class="c1">#* YAY we&#39;re done adding constraints. Now concatenate all the constraints into one big vector.</span>
        <span class="c1">#* note that while vertcat is typically slower than horzcat, since these are all vectors, it&#39;s the exact same memory operation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbg</span> <span class="o">=</span> <span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lbg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ubg</span> <span class="o">=</span> <span class="n">vertcat</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ubg</span><span class="p">)</span>

        <span class="c1">#* COST FUNCITON: # Math: \sum_{i=1}^N\left[ \Delta t_i + 10^5\cdot\sum(\text{sl}_\text{dyn})^2\right]</span>
        <span class="c1">#* slack vars aren&#39;t really neccessary for dynamics but I&#39;m too lazy to remove them. Really they should be on the cone constraints but it&#39;s ok.</span>
        <span class="c1"># adding the scalar portion will penalize having to use the scalar (i.e. giving too short a path)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">sum1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e12</span><span class="o">*</span><span class="n">sumsqr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sl_dyn</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">1e2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scalar</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1">#* construct the NLP dictionary to be passed into casadi.</span>
        <span class="c1"># make sure you add the self.scalar to x so the nlp can modify it!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlp</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">vertcat</span><span class="p">(</span><span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalar</span><span class="p">),</span>
            <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span>
            <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">,</span>
            <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">currAndCones</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_add_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">lbg</span><span class="p">,</span> <span class="n">ubg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;utility funciton to add a constraint and keep track of all the indices</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): name for this constraint (human-readable)</span>
<span class="sd">            g (casadi symbolic expression): expression to be constrained</span>
<span class="sd">            lbg (float): lower bound for g</span>
<span class="sd">            ubg (float): upper bound for g</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gtable</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">glen</span><span class="o">+</span><span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glen</span> <span class="o">+=</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ubg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ubg</span><span class="p">)</span>

<div class="viewcode-block" id="CompiledLocalOpt.construct_solver">
<a class="viewcode-back" href="../../local_path.html#local_path.local_opt_compiled.CompiledLocalOpt.construct_solver">[docs]</a>
    <span class="k">def</span> <span class="nf">construct_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_c</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compile_c</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_c</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gcc_opt_flag</span><span class="o">=</span><span class="s1">&#39;-Ofast&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;creates a solver object</span>

<span class="sd">        Args:</span>
<span class="sd">            generate_c (bool, optional): whether or not to generate new C code. Defaults to False.</span>
<span class="sd">            compile_c (bool, optional): whether or not to look for and compile the C code. Defaults to False.</span>
<span class="sd">            use_c (bool, optional): whether or not to load the compiled C code. Defaults to False.</span>
<span class="sd">            gcc_opt_flag (str, optional): optimization flags to pass to GCC. can be -O1, -O2, -O3, or -Ofast depending on how long you&#39;re willing to wait. Defaults to &#39;-Ofast&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">nlpsol</span><span class="p">(</span><span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlp_solver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sopts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generate_c</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">generate_dependencies</span><span class="p">(</span><span class="s1">&#39;local_opt.c&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mv local_opt.c </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="si">}</span><span class="s2">/local_opt.c&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compile_c</span><span class="p">:</span>  
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;gcc -fPIC </span><span class="si">{</span><span class="n">gcc_opt_flag</span><span class="si">}</span><span class="s1"> -shared </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="si">}</span><span class="s1">/local_opt.c -o </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="si">}</span><span class="s1">/local_opt.so&#39;</span><span class="p">)</span>
            <span class="c1"># os.system(f&#39;mv local_opt.so MPC/bin/local_opt.so&#39;) #TODO: fix this path if necessary</span>
        <span class="k">if</span> <span class="n">use_c</span><span class="p">:</span>
            <span class="n">new_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sopts</span>
            <span class="n">new_opts</span><span class="p">[</span><span class="s1">&#39;expand&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">nlpsol</span><span class="p">(</span><span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlp_solver</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="si">}</span><span class="s1">/local_opt.so&#39;</span><span class="p">,</span> <span class="n">new_opts</span><span class="p">)</span></div>

<div class="viewcode-block" id="CompiledLocalOpt.load_solver">
<a class="viewcode-back" href="../../local_path.html#local_path.local_opt_compiled.CompiledLocalOpt.load_solver">[docs]</a>
    <span class="k">def</span> <span class="nf">load_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;alternative to construct_solver if you&#39;re just loading a saved solver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sopts</span>
        <span class="n">new_opts</span><span class="p">[</span><span class="s1">&#39;expand&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">nlpsol</span><span class="p">(</span><span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlp_solver</span><span class="p">,</span> <span class="s1">&#39;local_opt.so&#39;</span><span class="p">,</span> <span class="n">new_opts</span><span class="p">)</span></div>


<div class="viewcode-block" id="CompiledLocalOpt.angle">
<a class="viewcode-back" href="../../local_path.html#local_path.local_opt_compiled.CompiledLocalOpt.angle">[docs]</a>
    <span class="k">def</span> <span class="nf">angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">cosine</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="nd">@b</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="n">cosine</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">cosine</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">cosine</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">cosine</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cosine</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]))</span></div>

    
<div class="viewcode-block" id="CompiledLocalOpt.to_constant_tgrid">
<a class="viewcode-back" href="../../local_path.html#local_path.local_opt_compiled.CompiledLocalOpt.to_constant_tgrid">[docs]</a>
    <span class="k">def</span> <span class="nf">to_constant_tgrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;converts a solver result to a constant-dt representation. z, u, and t can be passed in with **res (from solve())</span>

<span class="sd">        Args:</span>
<span class="sd">            dt (float): desired resultant time discretization interval</span>
<span class="sd">            z (np.ndarray): states from solver</span>
<span class="sd">            u (np.ndarray): controls from solver</span>
<span class="sd">            t (np.ndarray): timestamps from solver</span>

<span class="sd">        Returns:</span>
<span class="sd">            (np.ndarray, np.ndarray): arrays of states, controls</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">controls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">cur</span><span class="o">&lt;</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">cur</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">extra</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">&gt;</span><span class="mf">1.5</span><span class="o">*</span><span class="n">pi</span><span class="p">:</span>
                <span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>

            <span class="n">cur</span> <span class="o">+=</span> <span class="n">dt</span>
        <span class="c1"># now pad it until it&#39;s 12 timsteps, for safety</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">150</span><span class="p">:</span>
            <span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">dt</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">states</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">controls</span><span class="p">)</span></div>


        
<div class="viewcode-block" id="CompiledLocalOpt.solve">
<a class="viewcode-back" href="../../local_path.html#local_path.local_opt_compiled.CompiledLocalOpt.solve">[docs]</a>
    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">curr_state</span><span class="p">,</span> <span class="n">err_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;crunch the numbers.</span>

<span class="sd">        Args:</span>
<span class="sd">            left (np.ndarray): location of left cones. shape (N, 2).</span>
<span class="sd">            right (np.ndarray): location of right cones. shape (N, 2).</span>
<span class="sd">            curr_state (np.ndarray): current state of the car. shape (x, y, phi, v).</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: result of solve. keys &#39;z&#39; (states), &#39;u&#39; (controls), &#39;t&#39; (timestamps)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">left</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">right</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">curr_state</span><span class="p">))</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">right</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">diffs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">diffs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">diffs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">diffs</span><span class="p">))]</span>
        <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
        <span class="c1"># angles = np.cumsum(d_angles)</span>

        <span class="c1"># left = center</span>
        <span class="c1"># right = center</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;angles shape: </span><span class="si">{</span><span class="n">angles</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">vec</span><span class="p">(</span><span class="n">vertcat</span><span class="p">(</span>
            <span class="n">DM</span><span class="p">([</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="c1"># t</span>
            <span class="n">DM</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span>       <span class="c1"># psi</span>
            <span class="n">DM</span><span class="p">([</span><span class="n">curr_state</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="c1"># v</span>
            <span class="n">DM</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="c1"># a</span>
            <span class="n">DM</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span>
            <span class="n">DM</span><span class="p">([</span><span class="mf">0.1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="c1"># dt</span>
            <span class="n">DM</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span>
            <span class="n">DM</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span>         <span class="c1"># scalar</span>
        <span class="p">))</span>
        <span class="c1"># print(self.x0, self.x0.shape())</span>
        <span class="c1"># print(&quot;leo is mean!!!!!&quot;)</span>
        <span class="c1"># print(DM(curr_state).shape, horzcat(DM(left), DM(right)).shape)</span>
        <span class="c1"># print(dict(</span>
        <span class="c1">#     x0=self.x0,</span>
        <span class="c1">#     lbg=self.lbg,</span>
        <span class="c1">#     ubg=self.ubg,</span>
        <span class="c1">#     p=vertcat(DM(curr_state).T, horzcat(DM(left), DM(right))),</span>
        <span class="c1"># ))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span>
            <span class="n">x0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span>
            <span class="n">lbg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lbg</span><span class="p">,</span>
            <span class="n">ubg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ubg</span><span class="p">,</span>
            <span class="n">p</span><span class="o">=</span><span class="n">vertcat</span><span class="p">(</span><span class="n">DM</span><span class="p">(</span><span class="n">curr_state</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">horzcat</span><span class="p">(</span><span class="n">DM</span><span class="p">(</span><span class="n">left</span><span class="p">),</span> <span class="n">DM</span><span class="p">(</span><span class="n">right</span><span class="p">))),</span>
        <span class="p">)</span>
        <span class="c1"># print(&quot;SOLVE FINISHED&quot;)</span>
        <span class="k">if</span> <span class="n">err_ok</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">stats</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Solver failed to converge&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
        <span class="c1"># print(&quot;LOCAL OPT OUTPUT&quot;)</span>
        <span class="c1"># print(self.soln)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="s1">&#39;xy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">right</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># print(self.soln[&#39;x&#39;][:, 5])</span>
        <span class="n">res</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="s1">&#39;xy&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">])</span>
        <span class="c1"># print(&#39;silly:&#39;,res[&#39;z&#39;].shape)</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mf">0.</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][:,</span> <span class="mi">5</span><span class="p">])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        

        <span class="c1">## if the solved solution doesn&#39;t fill all 2 seconds</span>
        <span class="c1">### NAIVE (pad &quot;straight&quot; controls until 2 seconds are filled)</span>
        <span class="c1"># if res[&#39;t&#39;][-1] &lt; 2.0:</span>
        <span class="c1">#     step_size = res[&#39;t&#39;][1] - res[&#39;t&#39;][0]</span>
        <span class="c1">#     for i in range(res[&#39;t&#39;][-1], 2.0 + step_size, step_size):</span>
        <span class="c1">#         ###### TO DO ######</span>
        <span class="c1">#         # res[&#39;z&#39;] = np.append(res[&#39;&#39;])</span>
        <span class="c1">#         # res[&#39;u&#39;] = np.append(res[&#39;u&#39;], )</span>
        <span class="c1">#         res[&#39;t&#39;] = np.append(res[&#39;t&#39;], i)</span>
        <span class="c1">### IMPROVED (stretch optimized controls across the 2 seconds)</span>
        <span class="c1"># added constraint that the solution must be at least 2 seconds long</span>

        <span class="k">return</span> <span class="n">res</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Daniel Municio.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>